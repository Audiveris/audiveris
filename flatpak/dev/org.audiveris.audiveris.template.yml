# ----
# flatpak-builder manifest file template
# to be expanded and copied from flatpak/dev to flatpak/flathub
# via the gradle task :flatpak:genManifest
#
# Variables names and example values:
# - OPEN_JDK:       openjdk21
# - GRADLE_URL:     https\\://services.gradle.org/distributions/gradle-8.5-all.zip
# - GRADLE_NAME:    gradle-8.5-all.zip
# - GRADLE_SHA256:  c16d517b50dd28b3f5838f0e844b7520b8f1eb610f2f29de7e4e04a1b7c9c79b
# - TAG:            5.4-alpha
# ----

id: org.audiveris.audiveris
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.${OPEN_JDK}
build-options:
  append-path: "/usr/lib/sdk/${OPEN_JDK}/bin"
command: Audiveris
finish-args:
  # Network access
  - --share=network
  # X11 + XShm access
  - --share=ipc
  - --socket=x11
  # Needs to save files locally
  - --filesystem=xdg-documents
  - --filesystem=xdg-pictures
  - --env=PATH=/app/bin:/app/jre/bin:/usr/bin
  - --env=JAVA_HOME=/app/jre
  # Calling abort() on malloc-check doesn't fly with OpenJDK
  - --env=MALLOC_CHECK_=0
modules:
  - name: openjdk
    buildsystem: simple
    build-commands:
      - /usr/lib/sdk/${OPEN_JDK}/install.sh

  - name: audiveris
    buildsystem: simple
    build-commands:
      # (Assuming these commands are run from sandbox root)
      #
      # A few debugging stuff to be removed ASAP
      - echo "DEBUG ======================================================="
      - echo "DEBUG checking the pwd"
      - pwd
      - ls -l
      - echo "DEBUG ======================================================="
      
      # We make the Gradle wrapper use our local .zip file
      # NOTA: mind the fact that expand() will reduce the backslashes in template, so double them!
      - ln --force ${GRADLE_NAME} gradle/wrapper/${GRADLE_NAME}
      - sed --regexp-extended --in-place 's,https\\\\://services.gradle.org/distributions/,,' gradle/wrapper/gradle-wrapper.properties

      # Copy the Tesseract language files
      - echo "DEBUG Copy the Tesseract language files"
      - install --mode=0644 -D --target-directory=/app/share/tessdata *.traineddata

      # Copy some needed icons
      - echo "DEBUG Copy some needed icons"
      - install --mode=0644 -D app/res/icon-256.png /app/share/icons/hicolor/256x256/apps/org.audiveris.audiveris.png
      - install --mode=0644 -D app/res/icon-64.png /app/share/icons/hicolor/64x64/apps/org.audiveris.audiveris.png
      - install --mode=0644 -D app/src/main/java/org/audiveris/omr/ui/resources/icon-48.png /app/share/icons/hicolor/48x48/apps/org.audiveris.audiveris.png
      - install --mode=0644 -D app/src/main/java/org/audiveris/omr/ui/resources/icon-32.png /app/share/icons/hicolor/32x32/apps/org.audiveris.audiveris.png
      - install --mode=0644 -D app/src/main/java/org/audiveris/omr/ui/resources/icon-24.png /app/share/icons/hicolor/24x24/apps/org.audiveris.audiveris.png
      - install --mode=0644 -D app/src/main/java/org/audiveris/omr/ui/resources/icon-16.png /app/share/icons/hicolor/16x16/apps/org.audiveris.audiveris.png

      # Copy desktop and metainfo
      - echo "DEBUG Copy desktop and metainfo"
      - install --mode=0644 -D org.audiveris.audiveris.desktop /app/share/applications/org.audiveris.audiveris.desktop
      - install --mode=0644 -D org.audiveris.audiveris.metainfo.xml /app/share/metainfo/org.audiveris.audiveris.metainfo.xml

      # Run Gradle build in offline mode, with a specific repository (hence the isFlatpak property)
      - echo "DEBUG Run Gradle build in offline mode"
      - ./gradlew -PisFlatpak --offline :flatpak:buildFlatpak

      # Extract lib and bin from Audiveris .tar to /app
      - echo "DEBUG Extract lib and bin from Audiveris .tar to /app"
      - tar x --directory=/app --strip-components=1 --file app/build/distributions/Audiveris-*.tar

      # Insert TESSDATA_PREFIX in Audiveris sh file
      - echo "DEBUG Insert TESSDATA_PREFIX in Audiveris sh file"
      - sed --in-place --file=add-tessdata-prefix.sed /app/bin/Audiveris
      
      - echo "DEBUG This is the end."
    sources:
      # NOTA: Paths are relative to the location of the expanded template, that is flatpak/flathub
      
      # Audiveris project. We provide the tag only, not the commit value
      - type: git
        url: https://github.com/mwilck/audiveris
        tag: ${TAG}

      - type: file
        url: ${GRADLE_URL}
        sha256: ${GRADLE_SHA256}

      - type: file
        path: org.audiveris.audiveris.desktop

      - type: file
        path: org.audiveris.audiveris.metainfo.xml

      - type: file
        path: add-tessdata-prefix.sed

      # Include app dependencies.json, generated by Gradle task genDependencies
      - dependencies.json

      # Include lang_sources.yml, generated by Gradle task genLanguages
      - lang_sources.yml
